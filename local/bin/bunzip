#!/bin/bash

function progress {
        status=$(expr "$1")
        finish="$2"
        p=$(python3 -c "print(${status} / ${finish})")
        python3 -c "print( '#' * int((${p} * 40.0)) + '_' * int(( (1.0 - ${p}) * 40.0)) + ' ' + str(int(${p} * 100)) + '%  \r', end='')"
}

Max_Threads=`getconf _NPROCESSORS_ONLN`
Max_Threads=$((Max_Threads-2))

IF=$IFS
IFS=$'\n'

myArray=( "$@" )
total=`expr ${#myArray[@]} - 1`
#echo "TOTAL $total"; exit 0
c="0"

while [ $c -lt "$total" ]
do
	progress $c $total
	chunk="$c"
	threads="0"	
	while [[ "$chunk" -lt "$total" && "$threads" -lt "$Max_Threads" ]];
	do
		threads=$((threads+1))
		chunk=`expr $c + $threads`
	done

	threadList=()
	for n in `seq 0 $threads`
	do
		zip=${myArray[`expr $c + $n`]}
		folder="${zip%.zip}"
		mkdir -p "$folder"
		unzip -n -q "$zip" -d "$folder" &
		job=${!}
		threadList+=($job)
	done

	for j in ${threadList[@]}
	do
		wait $j
	done

	c=`expr $c + $threads + 1`

done
progress $total $total

IFS=$IF


